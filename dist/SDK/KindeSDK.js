var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports["default"]=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _Utils=require("./Utils");var _urlParse=_interopRequireDefault(require("url-parse"));var _reactNative=require("react-native");var _AuthorizationCode=_interopRequireDefault(require("./OAuth/AuthorizationCode"));var _Storage=_interopRequireDefault(require("./Storage"));var _authStatus2=_interopRequireDefault(require("./constants/auth-status.constants"));var _unauthenticated=require("../common/exceptions/unauthenticated.exception");var _jwtDecode=_interopRequireDefault(require("jwt-decode"));var _unexpected=require("../common/exceptions/unexpected.exception");var KindeSDK=function(){function KindeSDK(issuer,redirectUri,clientId,logoutRedirectUri){var scope=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'openid offline';var additionalParameters=arguments.length>5&&arguments[5]!==undefined?arguments[5]:{};(0,_classCallCheck2["default"])(this,KindeSDK);this.issuer=issuer;(0,_Utils.checkNotNull)(this.issuer,'Issuer');this.redirectUri=redirectUri;(0,_Utils.checkNotNull)(this.redirectUri,'Redirect URI');this.clientId=clientId;(0,_Utils.checkNotNull)(this.clientId,'Client Id');this.logoutRedirectUri=logoutRedirectUri;(0,_Utils.checkNotNull)(this.logoutRedirectUri,'Logout Redirect URI');this.additionalParameters=(0,_Utils.checkAdditionalParameters)(additionalParameters);this.scope=scope;this.clientSecret='';this.authStatus=_authStatus2["default"].UNAUTHENTICATED;}(0,_createClass2["default"])(KindeSDK,[{key:"login",value:function login(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};(0,_Utils.checkAdditionalParameters)(additionalParameters);this.cleanUp();var auth=new _AuthorizationCode["default"]();this.updateAuthStatus(_authStatus2["default"].AUTHENTICATING);var additionalParametersMerged=Object.assign({},this.additionalParameters,additionalParameters);return auth.login(this,true,'login',additionalParametersMerged);}},{key:"getToken",value:function getToken(url){var _this=this;if(this.checkIsUnAuthenticated()){throw new _unauthenticated.UnAuthenticatedException();}(0,_Utils.checkNotNull)(url,'URL');var URLParsed=(0,_urlParse["default"])(url,true);var _URLParsed$query=URLParsed.query,code=_URLParsed$query.code,error=_URLParsed$query.error,error_description=_URLParsed$query.error_description;if(error){var msg=error_description?error_description:error;throw new _unauthenticated.UnAuthenticatedException(msg);}(0,_Utils.checkNotNull)(code,'code');var formData=new FormData();formData.append('code',code);formData.append('client_id',this.clientId);formData.append('client_secret',this.clientSecret);formData.append('grant_type','authorization_code');formData.append('redirect_uri',this.redirectUri);var state=_Storage["default"].getState();if(state){formData.append('state',state);}var codeVerifier=_Storage["default"].getCodeVerifier();if(codeVerifier){formData.append('code_verifier',codeVerifier);}return new Promise(function(){var _ref=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(resolve,reject){var response,dataResponse,now,expiredAt;return _regenerator["default"].wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fetch(_this.tokenEndpoint,{method:'POST',headers:{'Content-Type':'multipart/form-data'},body:formData});case 2:response=_context.sent;_context.next=5;return response.json();case 5:dataResponse=_context.sent;if(!dataResponse.error){_context.next=9;break;}reject(dataResponse);return _context.abrupt("return");case 9:_this.saveUserDetails(dataResponse.id_token);_Storage["default"].setAccessToken(dataResponse.access_token);_Storage["default"].setIdToken(dataResponse.id_token);_this.updateAuthStatus(_authStatus2["default"].AUTHENTICATED);now=new Date().getTime();expiredAt=now+dataResponse.expires_in*1000;_Storage["default"].setExpiredAt(expiredAt);resolve(dataResponse);case 17:case"end":return _context.stop();}}},_callee);}));return function(_x,_x2){return _ref.apply(this,arguments);};}());}},{key:"register",value:function register(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};(0,_Utils.checkAdditionalParameters)(additionalParameters);var auth=new _AuthorizationCode["default"]();this.updateAuthStatus(_authStatus2["default"].AUTHENTICATING);return auth.login(this,true,'registration',additionalParameters);}},{key:"createOrg",value:function createOrg(){var additionalParameters=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return this.register(Object.assign({is_create_org:true},additionalParameters));}},{key:"logout",value:function logout(){this.cleanUp();var URLParsed=(0,_urlParse["default"])(this.logoutEndpoint,true);URLParsed.query['redirect']=this.logoutRedirectUri;return _reactNative.Linking.openURL(URLParsed.toString());}},{key:"cleanUp",value:function cleanUp(){this.updateAuthStatus(_authStatus2["default"].UNAUTHENTICATED);return _Storage["default"].clear();}},{key:"updateAuthStatus",value:function updateAuthStatus(_authStatus){this.authStatus=_authStatus;_Storage["default"].setAuthStatus(this.authStatus);}},{key:"checkIsUnAuthenticated",value:function checkIsUnAuthenticated(){var authStatusStorage=_Storage["default"].getAuthStatus();if((!this.authStatus||this.authStatus===_authStatus2["default"].UNAUTHENTICATED)&&(!authStatusStorage||authStatusStorage===_authStatus2["default"].UNAUTHENTICATED)){return true;}return false;}},{key:"getUserDetails",value:function getUserDetails(){return _Storage["default"].getUserProfile();}},{key:"saveUserDetails",value:function saveUserDetails(idToken){if(!idToken||typeof idToken!=='string'){_Storage["default"].removeItem('userProfile');return;}var token=(0,_jwtDecode["default"])(idToken);_Storage["default"].setUserProfile({id:token.sub,given_name:token.given_name,family_name:token.family_name,email:token.email});}},{key:"getClaims",value:function getClaims(){var tokenType=arguments.length>0&&arguments[0]!==undefined?arguments[0]:'accessToken';if(!['accessToken','id_token'].includes(tokenType)){throw new _unexpected.UnexpectedException('tokenType');}var token=_Storage["default"].getItem(tokenType);if(!token){throw new _unauthenticated.UnAuthenticatedException();}return(0,_jwtDecode["default"])(token);}},{key:"getClaim",value:function getClaim(keyName){var tokenType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'accessToken';return this.getClaims(tokenType)[keyName];}},{key:"getPermissions",value:function getPermissions(){var claims=this.getClaims();return{orgCode:claims['org_code'],permissions:claims['permissions']};}},{key:"getPermission",value:function getPermission(permission){var allClaims=this.getClaims();var permissions=allClaims['permissions'];return{orgCode:allClaims['org_code'],isGranted:permissions===null||permissions===void 0?void 0:permissions.includes(permission)};}},{key:"getOrganization",value:function getOrganization(){return{orgCode:this.getClaim('org_code')};}},{key:"getUserOrganizations",value:function getUserOrganizations(){return{orgCodes:this.getClaim('org_codes','id_token')};}},{key:"isAuthenticated",get:function get(){if(this.checkIsUnAuthenticated()){return false;}var timeExpired=Number(_Storage["default"].getExpiredAt());var now=new Date().getTime();return timeExpired>now;}},{key:"authorizationEndpoint",get:function get(){return this.issuer+"/oauth2/auth";}},{key:"tokenEndpoint",get:function get(){return this.issuer+"/oauth2/token";}},{key:"logoutEndpoint",get:function get(){return this.issuer+"/logout";}}]);return KindeSDK;}();exports["default"]=KindeSDK;